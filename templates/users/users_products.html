{% include 'header_users.html' %}

<div class="container py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="fas fa-shopping-cart me-2 text-primary"></i>Agricultural Products Marketplace
          </h2>
          <p class="text-muted mb-0">Browse and purchase products directly from farmers</p>
        </div>
        <a href="/users/dashboard/" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
 

  <!-- Search and Filter -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" class="form-control" id="searchInput" placeholder="Search products...">
      </div>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="categoryFilter">
        <option value="">All Categories</option>
        {% for category in categories %}
        <option value="{{ category.name }}">{{ category.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <select class="form-select" id="typeFilter">
        <option value="">All Types</option>
        <option value="seed">Seeds</option>
        <option value="fertilizer">Fertilizers</option>
        <option value="tool">Tools</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" id="sortFilter">
        <option value="newest">Newest First</option>
        <option value="price_low">Price: Low to High</option>
        <option value="price_high">Price: High to Low</option>
        <option value="name">Name: A to Z</option>
      </select>
    </div>
  </div>

  <!-- Products Grid -->
  <div class="row g-4" id="productsGrid">
    {% for product in products %}
    <div class="col-md-6 col-lg-4 product-item" 
         data-category="{{ product.category.name }}" 
         data-type="{{ product.product_type }}"
         data-name="{{ product.product_name|lower }}"
         data-price="{{ product.price }}">
      <div class="card product-card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="badge {% if product.stock_quantity > 10 %}bg-success{% elif product.stock_quantity > 0 %}bg-warning{% else %}bg-danger{% endif %}">
            {% if product.stock_quantity > 10 %}In Stock{% elif product.stock_quantity > 0 %}Low Stock{% else %}Out of Stock{% endif %}
          </span>
          <span class="badge bg-secondary">{{ product.get_product_type_display }}</span>
        </div>
        
        <div class="card-body">
          <div class="text-center mb-3">
            {% if product.image %}
              <img src="/media/{{ product.image }}" alt="{{ product.product_name }}" 
                   class="product-image rounded" style="width: 120px; height: 100px; object-fit: cover;">
            {% else %}
              <div class="rounded bg-light d-inline-flex align-items-center justify-content-center product-image-placeholder" 
                   style="width: 120px; height: 100px;">
                <i class="fas fa-image text-muted" style="font-size: 2rem;"></i>
              </div>
            {% endif %}
          </div>
          
          <h6 class="card-title text-center">{{ product.product_name }}</h6>
          <p class="card-text text-muted small">{{ product.description|truncatewords:15 }}</p>
          
          <div class="row text-center mb-3">
            <div class="col-6">
              <strong class="text-success">â‚¹{{ product.price }}</strong>
              <br><small class="text-muted">Price</small>
            </div>
            <div class="col-6">
              <strong class="{% if product.stock_quantity > 10 %}text-success{% elif product.stock_quantity > 0 %}text-warning{% else %}text-danger{% endif %}">
                {{ product.stock_quantity }}
              </strong>
              <br><small class="text-muted">Available</small>
            </div>
          </div>
          
          <div class="mb-3">
            <small class="text-muted">
              <i class="fas fa-tag me-1"></i>{{ product.category.name }}
            </small>
          </div>
          
          <div class="mb-3">
            <small class="text-muted">
              <i class="fas fa-calendar me-1"></i>Added: {{ product.created_at|date:"M d, Y" }}
            </small>
          </div>
        </div>
        
        <div class="card-footer bg-transparent">
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewProduct({{ product.id }})">
              <i class="fas fa-eye me-1"></i>View Details
            </button>
            {% if product.stock_quantity > 0 %}
            <button class="btn btn-sm btn-success flex-fill" onclick="addToCart({{ product.id }})">
              <i class="fas fa-cart-plus me-1"></i>Add to Cart
            </button>
            {% else %}
            <button class="btn btn-sm btn-secondary flex-fill" disabled>
              <i class="fas fa-times me-1"></i>Out of Stock
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="alert alert-info text-center">
        <i class="fas fa-info-circle me-2"></i>
        No products available at the moment. Please check back later!
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Stock Statistics -->
  <div class="row mt-5">
    <div class="col-12">
      <h4 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Stock Statistics</h4>
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <i class="fas fa-box text-primary mb-2" style="font-size: 2rem;"></i>
              <h4 class="text-primary">{{ total_products }}</h4>
              <p class="mb-0">Total Products</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <i class="fas fa-check-circle text-success mb-2" style="font-size: 2rem;"></i>
              <h4 class="text-success">{{ in_stock }}</h4>
              <p class="mb-0">In Stock</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <i class="fas fa-exclamation-triangle text-warning mb-2" style="font-size: 2rem;"></i>
              <h4 class="text-warning">{{ low_stock }}</h4>
              <p class="mb-0">Low Stock</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <i class="fas fa-times-circle text-danger mb-2" style="font-size: 2rem;"></i>
              <h4 class="text-danger">{{ out_of_stock }}</h4>
              <p class="mb-0">Out of Stock</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.product-card {
  transition: transform 0.2s, box-shadow 0.2s;
  border: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

.product-image {
  border: 2px solid #e9ecef;
}

.product-image-placeholder {
  border: 2px dashed #dee2e6;
}

.card-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid #dee2e6;
}

.form-control:focus, .form-select:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.btn-success {
  background-color: #28a745;
  border-color: #28a745;
}

.btn-success:hover {
  background-color: #218838;
  border-color: #1e7e34;
}

.product-item.hidden {
  display: none;
}
</style>

<script>
// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const typeFilter = document.getElementById('typeFilter');
  const sortFilter = document.getElementById('sortFilter');
  const productsGrid = document.getElementById('productsGrid');
  const productItems = document.querySelectorAll('.product-item');

  function filterProducts() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;
    const selectedType = typeFilter.value;

    productItems.forEach(item => {
      const name = item.dataset.name;
      const category = item.dataset.category;
      const type = item.dataset.type;
      
      const matchesSearch = name.includes(searchTerm);
      const matchesCategory = !selectedCategory || category === selectedCategory;
      const matchesType = !selectedType || type === selectedType;
      
      if (matchesSearch && matchesCategory && matchesType) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  function sortProducts() {
    const sortBy = sortFilter.value;
    const items = Array.from(productItems);
    
    items.sort((a, b) => {
      switch(sortBy) {
        case 'price_low':
          return parseFloat(a.dataset.price) - parseFloat(b.dataset.price);
        case 'price_high':
          return parseFloat(b.dataset.price) - parseFloat(a.dataset.price);
        case 'name':
          return a.dataset.name.localeCompare(b.dataset.name);
        default: // newest
          return 0; // Already sorted by newest in the backend
      }
    });
    
    items.forEach(item => productsGrid.appendChild(item));
  }

  // Event listeners
  searchInput.addEventListener('input', filterProducts);
  categoryFilter.addEventListener('change', filterProducts);
  typeFilter.addEventListener('change', filterProducts);
  sortFilter.addEventListener('change', sortProducts);
});

// Product action functions
function viewProduct(productId) {
  alert(`Viewing product ${productId} details (Demo - will show detailed product page)`);
}

function addToCart(productId) {
  alert(`Product ${productId} added to cart successfully! (Demo - cart functionality will be implemented)`);
}
</script>

{% include 'footer.html' %} 